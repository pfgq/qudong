#include <fcntl.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

#define PERF_HOOK_MAGIC     'p'
#define PERF_IOCTL_RW_WATCH _IOW(PERF_HOOK_MAGIC, 3, struct perf_hook_req)

struct perf_hook_req {
    int            pid;
    unsigned long  addr;
    int            reg;
    unsigned int   bp_len;
};

int main(void)
{
    int fd = open("/dev/perf_hook", O_RDONLY);
    if (fd < 0) {
        perror("open");
        return 1;
    }

    struct perf_hook_req req;
    memset(&req, 0, sizeof(req));

    req.pid    = 14259;
    req.addr   = 0x5917bb7880;
    req.reg    = 0;   // x0
    req.bp_len = 8;   // long / pointer

    printf("[client] install RW watch...\n");
    ioctl(fd, PERF_IOCTL_RW_WATCH, &req);

    while (1) {
        char buf[256] = {0};
        lseek(fd, 0, SEEK_SET);
        read(fd, buf, sizeof(buf) - 1);
        printf("%s\n", buf);
        sleep(1);
    }

    close(fd);
    return 0;
}
